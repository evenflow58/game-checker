version: 0.2

phases:
  pre_build:
    commands:
      - echo "Deploying Settings Lambdas..."
      - echo "Lambda Role ARN - $LAMBDA_ROLE_ARN"
      - echo "Copying built artifacts from secondary source..."
      - cp -r $CODEBUILD_SRC_DIR_LambdasBuildOutput/api/v1/settings/get/dist api/v1/settings/get/ || echo "No settings GET dist"
      - cp -r $CODEBUILD_SRC_DIR_LambdasBuildOutput/api/v1/settings/get/node_modules api/v1/settings/get/ || echo "No settings GET node_modules"
      - cp -r $CODEBUILD_SRC_DIR_LambdasBuildOutput/api/v1/settings/put/dist api/v1/settings/put/ || echo "No settings PUT dist"
      - cp -r $CODEBUILD_SRC_DIR_LambdasBuildOutput/api/v1/settings/put/node_modules api/v1/settings/put/ || echo "No settings PUT node_modules"
      - cp -r $CODEBUILD_SRC_DIR_LambdasBuildOutput/api/v1/user/post/dist api/v1/user/post/ || echo "No user POST dist"
      - cp -r $CODEBUILD_SRC_DIR_LambdasBuildOutput/api/v1/user/post/node_modules api/v1/user/post/ || echo "No user POST node_modules"
      - echo "Retrieving Google OAuth credentials if auth enabled..."
      - |
        if [ "$ENABLE_AUTH" = "true" ] && [ -n "$GOOGLE_CREDENTIALS_SECRET_ARN" ]; then
          echo "Retrieving Google OAuth credentials from Secrets Manager..."
          GOOGLE_CLIENT_ID=$(aws secretsmanager get-secret-value --secret-id $GOOGLE_CREDENTIALS_SECRET_ARN --region $AWS_REGION --query 'SecretString' --output text | jq -r '.client_id')
          export GOOGLE_CLIENT_ID
          echo "Google Client ID retrieved successfully"
        else
          echo "Authentication disabled or no secret ARN provided"
          export GOOGLE_CLIENT_ID=""
        fi

  build:
    commands:
      - |
        API_ID=$(aws apigatewayv2 get-apis --region $AWS_REGION --query "Items[?Name=='${ENVIRONMENT}-GameCheckerAPI'].ApiId" --output text)
        export API_ID
        echo "API ID: $API_ID"
      
      - echo "Deploying Settings GET..."
      - cd api/v1/settings/get
      - |
        export FUNCTION_NAME="${ENVIRONMENT}-SettingsGet"
        export API_NAME="${ENVIRONMENT}-GameCheckerAPI"
        export ENABLE_AUTH="${ENABLE_AUTH:-true}"
        export GOOGLE_CLIENT_ID="${GOOGLE_CLIENT_ID}"
        export TABLE_NAME="${ENVIRONMENT}-GameCheckerTable"
        node dist/deploy.js
      - cd ../../../..
      
      - echo "Deploying Settings PUT..."
      - cd api/v1/settings/put
      - |
        export FUNCTION_NAME="${ENVIRONMENT}-SettingsPut"
        export API_NAME="${ENVIRONMENT}-GameCheckerAPI"
        export ENABLE_AUTH="${ENABLE_AUTH:-true}"
        export GOOGLE_CLIENT_ID="${GOOGLE_CLIENT_ID}"
        export TABLE_NAME="${ENVIRONMENT}-GameCheckerTable"
        node dist/deploy.js
      - cd ../../../..
      
      - echo "Deploying User POST..."
      - cd api/v1/user/post
      - |
        export FUNCTION_NAME="${ENVIRONMENT}-UserPost"
        export API_NAME="${ENVIRONMENT}-GameCheckerAPI"
        export ENABLE_AUTH="${ENABLE_AUTH:-true}"
        export GOOGLE_CLIENT_ID="${GOOGLE_CLIENT_ID}"
        export TABLE_NAME="${ENVIRONMENT}-GameCheckerTable"
        node dist/deploy.js
      - cd ../../../..

  post_build:
    commands:
      - echo "âœ… Settings and User Lambdas deployed!"
